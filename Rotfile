#!/usr/bin/env run-cargo-script
//#![feature(plugin)]

//#![plugin(rot)]
//extern crate rot;

//use rot::*;

use std::process::Command;
use std::env;

//#[task]
fn build() {
    Command::new("cargo")
        .arg("build")
        .status()
        .unwrap();
}

//#[task(test)]
fn release() {
    test();
    Command::new("cargo")
        .arg("build")
        .arg("--release")
        .status()
        .unwrap();
}

//#[task]
fn test() {
    Command::new("cargo")
        .arg("test")
        .status()
        .unwrap();
}

//#[task(release)]
fn install() {
    release();
    Command::new("find")
        .arg("./target/release")
        .arg("-maxdepth").arg("1")
        .arg("-type").arg("f")
        .arg("-executable")
        .arg("-exec").arg("install")
            .arg("-D").arg("-v").arg("-s")
            .arg("-o").arg("root")
            .arg("-g").arg("root")
            .arg("-m").arg("0755")
            .arg("-t").arg("/usr/local/bin")
            .arg("{}").arg("+")
        .status()
        .unwrap();
}

fn help() {
    println!("Usage:
    ./Rotfile TARGET

Available targets:

    build
    release
    test
    install
");
}

fn main() {
    let mut args = env::args();
    let _ = args.next().unwrap();

    let target = args.next().expect("target name expected; type './Rotfile help' for a list of targets");
    match &*target {
        "build" => build(),
        "release" => release(),
        "test" => test(),
        "install" => install(),
        "help" => help(),
        _ => panic!("unknown target name: {}", target),
    }
}
